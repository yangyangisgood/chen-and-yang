<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>é™³è·Ÿæ´‹ã„‰å¾…è¾¦æ¸…å–®</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">
    <!-- title -->
    <h1>å¾…è¾¦æ¸…å–®</h1>

    <!-- æ–°å¢é …ç›® form -->
    <form id="todo-form" autocomplete="off">
      <input type="text" id="new-todo" placeholder="æ–°å¢å¾…è¾¦..." />
      <button class="add-btn" type="submit">æ–°å¢</button>
    </form>

    <!-- å¾…è¾¦äº‹é … todo list -->
    <ul id="todo-list"></ul>

    <!-- é€²åº¦æ¢ progress bar -->
    <div id="progress-bar-container">
      <div id="progress-label">å·²å®Œæˆ 0 / 0ï¼ˆ0%ï¼‰</div>
      <div id="progress-bar">
        <div id="progress-bar-fill"></div>
      </div>
    </div>

    <!-- èŠ±èŠ±è£é£¾ deco-flower -->
    <div class="deco-container">
      <a href="https://docs.google.com/spreadsheets/d/1MMnLWBfr-XKPe99Pm5mKrlj0aI1wpG2LPC8hPKLog2U/edit?usp=sharing"
        target="_blank">
        <img src="./image/f1@3x.png" class="deco-items" id="orange-flower">
      </a>
      <!-- <img src="./image/f2@3x.png" class="deco-items" id="white-flower"> -->
      <!-- <img src="./image/f3@3x.png" class="deco-items" id="blue-flower"> -->
    </div>
  </div>

  <!-- è¼‰å…¥ loader -->
  <div id="loader">
    <span class="loader-icon"></span>
    <span style="margin-left:8px;">è¼‰å…¥ä¸­...</span>
  </div>

  <!-- å®Œæˆã„‰æ„›å¿ƒ -->
  <div id="heart-burst">
    <svg xmlns="http://www.w3.org/2000/svg" class="heart-icon" viewBox="0 0 16 16" fill="#FF69B4">
      <path
        d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15" />
    </svg>
  </div>


  <script>

    /* Google Apps Script URL **/
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbz_ls8nqd7ArsdeHJS2BotDasBAr4sP4O08LivCtdFswJPulsuswrnnQ7SrXW7hwxmi/exec';

    /* æŠ“DOMç¯€é» **/
    const form = document.getElementById('todo-form');
    const input = document.getElementById('new-todo');
    const list = document.getElementById('todo-list');
    const loader = document.getElementById('loader');

    /* å­˜æ”¾todo in local (ç‚ºäº†è®Šæ›´ç‹€æ…‹å…ˆé¡¯ç¤ºUI) **/
    let todos = [];

    /* é¡¯ç¤ºèˆ‡é—œé–‰loader **/
    function showLoader() {
      loader.style.display = 'block';
      input.disabled = true;
      Array.from(document.querySelectorAll('.del-btn')).forEach(btn => btn.disabled = true);
    }
    function hideLoader() {
      loader.style.display = 'none';
      input.disabled = false;
      Array.from(document.querySelectorAll('.del-btn')).forEach(btn => btn.disabled = false);
    }

    /* è¼‰å…¥todoè³‡æ–™ **/
    function loadTodos() {
      showLoader();
      fetch(`${GAS_URL}?action=list`)
        .then(res => res.json())
        .then(data => {
          todos = data;
          renderList();
        })
        .catch(() => alert('ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS è¨­å®šã€‚'))
        .finally(hideLoader);
    }

    /* æ¸²æŸ“UI **/
    function renderList() {
      list.innerHTML = '';
      todos.forEach((todo, idx) => {
        // æ˜¯å¦å®Œæˆ
        const li = document.createElement('li');
        if (todo.checked === true || todo.checked === 'true') li.classList.add('checked');
        // todoå…§å®¹
        const span = document.createElement('span');
        span.textContent = todo.content;
        // åˆªé™¤éµ
        const del = document.createElement('button');
        del.className = 'del-btn';
        // åƒåœ¾æ¡¶icon
        del.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
      </svg>
    `;
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteTodo(todo.id);
        });

        li.addEventListener('click', () => toggleTodoUI(idx));

        li.appendChild(span);
        li.appendChild(del);
        list.appendChild(li);
      });

      updateProgress()
    }

    /* æ–°å¢é …ç›® **/
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const content = input.value.trim();
      if (!content) return;

      // å…ˆåœ¨å‰ç«¯å»ºç«‹æš«æ™‚ ID èˆ‡é …ç›®
      const tempId = 'temp-' + Date.now();
      const newTodo = { id: tempId, content, checked: false };
      todos.push(newTodo);
      renderList();

      // æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œè®“ä½¿ç”¨è€…ç¹¼çºŒè¼¸å…¥
      input.value = '';

      // ç„¶å¾Œå†è·‘ API
      fetch(`${GAS_URL}?action=add&content=${encodeURIComponent(content)}`)
        .then(res => res.json())
        .then(data => {
          if (data.id) {
            // ç”¨ API å›å‚³çš„ id æ›¿æ›æš«æ™‚ ID
            const idx = todos.findIndex(t => t.id === tempId);
            if (idx !== -1) {
              todos[idx].id = data.id;
            }
          } else {
            throw new Error('API æœªå›å‚³ ID');
          }
        })
        .catch(() => {
          // æ–°å¢å¤±æ•—å°±æŠŠæš«æ™‚é …ç›®ç§»é™¤
          todos = todos.filter(t => t.id !== tempId);
          alert('æ–°å¢å¤±æ•—');
        })
        .finally(() => renderList());
    });


    /* åˆ‡æ›(å®Œæˆ/æœªå®Œæˆ)ç‹€æ…‹ï¼Œå…ˆé¡¯ç¤ºUIå†call api**/
    function toggleTodoUI(idx) {
      const todo = todos[idx];
      const oldChecked = todo.checked === true || todo.checked === 'true';
      todo.checked = !oldChecked;
      renderList(); // ç«‹å³åˆ‡æ›UI

      fetch(`${GAS_URL}?action=update&id=${todo.id}&checked=${todo.checked}`)
        .then(res => res.json())
        .then(ret => {
          if (ret.status !== "success") throw new Error('API failed');
        })
        .catch(() => {
          todo.checked = oldChecked;
          renderList();
          alert('ç‹€æ…‹åŒæ­¥å¤±æ•—ï¼Œå·²é‚„åŸã€‚');
        });
    }

    /* åˆªé™¤é …ç›® **/
    function deleteTodo(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å¾…è¾¦äº‹é …å—ï¼Ÿ')) return;

      // æ‰¾å‡ºé …ç›®ä¸¦å…ˆå¾ UI ä¸­ç§»é™¤
      const idx = todos.findIndex(t => t.id === id);
      if (idx === -1) return;
      const deletedTodo = todos[idx];
      todos.splice(idx, 1);
      renderList();

      // å†é€ API åˆªé™¤
      fetch(`${GAS_URL}?action=delete&id=${id}`)
        .then(res => res.json())
        .then(ret => {
          if (ret.status !== 'success') throw new Error('API failed');
        })
        .catch(() => {
          // å¦‚æœå¤±æ•—ï¼Œé‡æ–°åŠ å› UI
          todos.splice(idx, 0, deletedTodo);
          renderList();
          alert('åˆªé™¤å¤±æ•—ï¼Œå·²é‚„åŸã€‚');
        });
    }

    /* æ›´æ–°é€²åº¦æ¢ **/
    function updateProgress() {
      const total = todos.length;
      const done = todos.filter(t => t.checked === true || t.checked === 'true').length;
      const percent = total === 0 ? 0 : Math.round((done / total) * 100);

      const label = document.getElementById('progress-label');
      const fill = document.getElementById('progress-bar-fill');

      label.textContent = `å·²å®Œæˆ ${done} / ${total}ï¼ˆ${percent}%ï¼‰`;
      fill.style.width = `${percent}%`;

      if (percent === 100) {
        fill.style.backgroundColor = '#f39083'; // ğŸ’— ç²‰ç´…è‰²
        triggerHeartBurst(); // é¡¯ç¤ºæ„›å¿ƒ
      } else {
        fill.style.backgroundColor = '#69491A'; // æ£•è‰²ï¼ˆåŸè‰²ï¼‰
      }
    }

    /* é¡¯ç¤ºæ„›å¿ƒ **/
    function triggerHeartBurst() {
      const heart = document.getElementById('heart-burst');
      heart.classList.remove('animate'); // é‡è¨­å‹•ç•«
      void heart.offsetWidth; // è§¸ç™¼ reflow å¼·åˆ¶é‡è·‘å‹•ç•«
      heart.classList.add('animate');
    }


    /* åˆæ¬¡é€²å…¥pageè‡ªå‹•æ’ˆè³‡æ–™ **/
    loadTodos();

  </script>
</body>

</html>
